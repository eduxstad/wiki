<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
<meta name="description" content="Documentation for configuration on Diode">
<meta name="keywords" content="example, purdue, wiki">

    <title>Diode Documentation | PurdueLUG Wiki</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> 
    <script src="/wiki/static/mustachejs/mustache.js"></script>
    <link rel="stylesheet" href="/wiki/static/style/style.css">
    <link rel="icon" type="image/png" sizes="32x32" href="/wiki/static/style/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/wiki/static/style/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/wiki/static/style/favicon-16x16.png"> 
    <style type="text/css">
    @import url("/wiki/static/fonts/fontawesome.css");
    /* fontawesome */
    [class*="fontawesome-"]:before {
      font-family: 'FontAwesome', sans-serif;
    }
    </style> 
    <script>
    // Globals
    var has_gaq = false;
    </script>
    <!-- no style head.html found -->
</head>
<body>

<div id="content" class="container">
<div class="top-menu">
<div class="container">
  <div class="top-menu-mob">
    <a class="top-menu-link" href="#" onclick="toggleMobMenu();"><span class="fontawesome-reorder"></span></a>
  </div>
  <div class="top-menu-full mob-hidden">
    
    <div class="top-menu-item">
      
        <a href="/wiki/index.html" class="top-menu-link">Welcome</a>
      
    </div>
  
    <div class="top-menu-item">
      
        <a href="/wiki/posts.html" class="top-menu-link">Posts</a>
      
    </div>
  
    <div class="top-menu-item">
      
        <a href="/wiki/search.html" class="top-menu-link">Search</a>
      
    </div>
  
    <div class="top-menu-item">
      
        <a href="http://pykwiki.nullism.com" class="top-menu-link">PyKwiki Docs</a>
      
    </div>
  
    <div class="top-menu-item-right">
      <form method="get" action="/wiki/search.html">
        <input type="text" name="q" class="input-text top-menu-search-field" placeholder="Search">
      </form>
    </div>
  </div>
</div>
    <div class="clear"></div>
</div><!-- end top-menu -->

<script>
function menuClick(i) 
{
    if($("#submenu_"+i).is(":visible"))
    {
        $("#submenu_"+i).hide();
        $("#menuparent_"+i).removeClass('active');
    }
    else 
    {
        hideAllSubmenus();
        $("#submenu_"+i).show();
        $("#menuparent_"+i).addClass('active');
    }
    return false;
}

function hideAllSubmenus() {
    $('.submenu').hide();
    $('.top-menu-parent').removeClass('active');
}

var showMobMenu = false;
function toggleMobMenu() {
    if(showMobMenu) {
        $(".top-menu-full").addClass('mob-hidden');
    } else { 
        $(".top-menu-full").removeClass('mob-hidden');
    }
    showMobMenu = !showMobMenu;
    return false;
}
</script>

<script>
$(document).ready(function() { 
    $('.submenu').hide();
});

$(document).click(function(e) {
    var tgt = $(e.target);
    if(!tgt.is('.top-menu-parent') && !tgt.is('.fontawesome-caret-down')) {
        hideAllSubmenus();
    }
});
</script>


<script>
var tocOpen = true;
function toggleToc() { 
    if(tocOpen) { 
        hideToc();
    } else { 
        showToc();
    }
    return false;
}
function showToc() { 
    $(".toc").show();
    $(".toc-control").removeClass("toc-control-closed");
    $(".toc-control").addClass("toc-control-open");
    tocOpen = true;
}
function hideToc() { 
    $(".toc").hide();
    $(".toc-control").removeClass("toc-control-open");
    $(".toc-control").addClass("toc-control-closed");
    tocOpen = false;
}
</script>

<div class="post-wrap">

<!-- no style post.html found -->




<div class="post-content">
<div class="post">


<div class="post-author-block">
  Posted on <strong>2017-09-01 19:20</strong> by <strong>PLUG</strong>
</div>


<div class="post-tags">
  
  <div class="clear"></div>
</div>

<h1 id="lxc">LXC</h1>
<h2 id="command-examples">Command Examples</h2>
<p>Create new container</p>
<div class="codehilite"><pre><span></span>sudo lxc-create -n plug -t fedora -B btrfs
sudo vi /etc/lxc/dnsmasq.conf # see config examples
</pre></div>


<p>List existing containers</p>
<div class="codehilite"><pre><span></span>sudo lxc-ls -f
</pre></div>


<p>Attach existing container</p>
<div class="codehilite"><pre><span></span>sudo lxc-attach -n plug
</pre></div>


<h2 id="config-examples">Config Examples</h2>
<p><strong>/etc/lxc/lxc.conf</strong> - set path for containers to be stored (default /var/lib/lxc)</p>
<div class="codehilite"><pre><span></span>lxc.lxcpath = &quot;/lxc&quot;
</pre></div>


<p><strong>/etc/lxc/default.conf</strong> - config options for all newly created containers to inherit</p>
<div class="codehilite"><pre><span></span>lxc.network.type = veth
lxc.network.link = lxcbr0
lxc.network.flags = up
lxc.network.hwaddr = 00:16:3e:xx:xx:xx
lxc.start.auto = 1

# address
#lxc.network.ipv4 = 192.168.1.1xx
lxc.network.ipv4.gateway = 192.168.1.1

# memory
lxc.cgroup.memory.limit_in_bytes = 512M

# memory + swap
lxc.cgroup.memory.memsw.limit_in_bytes = 1G
</pre></div>


<p><strong>/etc/default/lxc-net</strong> - it may be necessary to add /etc/lxc/dnsasq.conf to the apparmor profile (/etc/apparmor.d/<em>dnsmasq</em>) with read privileges</p>
<div class="codehilite"><pre><span></span>USE_LXC_BRIDGE=&quot;true&quot;
LXC_BRIDGE=&quot;lxcbr0&quot;
LXC_ADDR=&quot;192.168.1.1&quot;
LXC_NETMASK=&quot;255.255.255.0&quot;
LXC_NETWORK=&quot;192.168.1.0/24&quot;
LXC_DHCP_RANGE=&quot;192.168.1.100,192.168.1.199&quot;
LXC_DHCP_MAX=&quot;100&quot;
LXC_DHCP_CONFILE=&quot;/etc/lxc/dnsmasq.conf&quot;
LXC_DOMAIN=&quot;&quot;
</pre></div>


<p><strong>/etc/lxc/dnsmasq.conf</strong></p>
<div class="codehilite"><pre><span></span>dhcp-host=evan,192.168.1.102
</pre></div>


<p><strong>iptables config</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Evan Widloski - 2016-11-11</span>
<span class="c1"># Diode iptables rules</span>

<span class="c1"># filter table: flush all chains, and delete all user added chains</span>
iptables -F
iptables -X
<span class="c1"># nat table: flush all chains, and delete all user added chains</span>
iptables -t nat -F
iptables -t nat -X

<span class="c1"># set default policies to DROP packets</span>
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

<span class="c1"># allow inbound outbound traffic on host </span>
iptables -A OUTPUT -o enp6s0f0 -d <span class="m">0</span>.0.0.0/0 -j ACCEPT 
iptables -A INPUT -i enp6s0f0 -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="c1"># set up chain for sshguard</span>
iptables -N sshguard
iptables -A INPUT -p tcp --dport <span class="m">22</span> -j sshguard

<span class="c1"># allow ssh</span>
iptables -A INPUT -i enp6s0f0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o enp6s0f0 -p tcp --sport <span class="m">22</span> -m state --state ESTABLISHED -j ACCEPT

<span class="c1"># allow mosh</span>
iptables -A INPUT -i enp6s0f0 -p udp --dport <span class="m">60000</span>:61000 -j ACCEPT
iptables -A OUTPUT -o enp6s0f0 -p udp --sport <span class="m">60000</span>:61000 -j ACCEPT

<span class="c1"># allow connections to varnish service</span>
<span class="c1">#iptables -A INPUT -i enp6s0f0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span>
<span class="c1">#iptables -A OUTPUT -o enp6s0f0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</span>

<span class="c1"># allow host to access LXC targets via network</span>
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -s <span class="m">192</span>.168.1.0/24 -j ACCEPT

<span class="c1"># allow outbound traffic for lxc containers</span>
iptables -A FORWARD -i lxcbr0 -j ACCEPT
iptables -t nat -A POSTROUTING -s <span class="m">192</span>.168.1.0/24 -j MASQUERADE

<span class="c1"># after incoming packets have been NAT&#39;ed (see below), allow them to pass through</span>
<span class="c1"># the forward chain to their intended LXC target</span>
iptables -A FORWARD -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT

<span class="c1">##------------ evan --------------</span>
<span class="c1">## ssh</span>
iptables -t nat -A PREROUTING -p tcp --dport <span class="m">20022</span> -j DNAT --to-destination <span class="m">192</span>.168.1.102:22
</pre></div>
</td></tr></table>


</div><!-- end post -->
</div><!-- end post-content -->

</div><!-- end post-wrap -->

</div><!-- End #content -->
<div class="clear"></div>
<div id="footer">
    <!-- no style footer.html found -->
    <div class="container" style="text-align: center;">
        <div>
        <p class="text-muted credit">&copy; 2016 PurdueLUG Wiki
        &mdash; powered by <a href="http://pykwiki.nullism.com">PyKwiki</a>
        </p>
        </div>

        

        

        


        <div class="social-div">
            <a href="/wiki/rss.xml"
                class="icon-link"><b class="big-icon fontawesome-rss"></b>RSS</a>
        </div>

        <div class="clear"></div>
    </div>
</div>
</body>
</html>